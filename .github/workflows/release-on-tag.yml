name: Release Plugin On Tag

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  update-version-file:
    name: Commit Tag Version To build.gradle.kts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0

      - name: Compute version from tag
        id: version
        shell: bash
        run: |
          RAW_TAG="${GITHUB_REF_NAME}"
          VERSION="${RAW_TAG#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Using plugin version: ${VERSION}"

      - name: Update version in build.gradle.kts
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -E -i.bak "s/^version = \".*\"$/version = \"${VERSION}\"/" build.gradle.kts
          rm -f build.gradle.kts.bak

      - name: Commit and push version update
        shell: bash
        run: |
          if git diff --quiet -- build.gradle.kts; then
            echo "build.gradle.kts already has version ${{ steps.version.outputs.version }}"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add build.gradle.kts
          git commit -m "chore: set plugin version to ${{ steps.version.outputs.version }}"
          if ! git push origin "HEAD:${{ github.event.repository.default_branch }}"; then
            echo "::warning::Could not push version commit to ${{ github.event.repository.default_branch }} (possibly branch protection). Continuing release."
          fi

  build-sign-publish:
    name: Build Sign Publish Plugin
    runs-on: ubuntu-latest
    needs: update-version-file

    steps:
      - name: Checkout tag commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Compute version from tag
        id: version
        shell: bash
        run: |
          RAW_TAG="${GITHUB_REF_NAME}"
          VERSION="${RAW_TAG#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Using plugin version: ${VERSION}"

      - name: Update version for build
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -E -i.bak "s/^version = \".*\"$/version = \"${VERSION}\"/" build.gradle.kts
          rm -f build.gradle.kts.bak

      - name: Materialize signing files
        shell: bash
        run: |
          CERT_PATH="$RUNNER_TEMP/certificate-chain.pem"
          KEY_PATH="$RUNNER_TEMP/private-key.pem"

          printf '%s' "${{ secrets.JETBRAINS_CERTIFICATE_CHAIN }}" > "$CERT_PATH"
          printf '%s' "${{ secrets.JETBRAINS_PRIVATE_KEY }}" > "$KEY_PATH"
          chmod 600 "$KEY_PATH"

          echo "CERTIFICATE_CHAIN_FILE=$CERT_PATH" >> "$GITHUB_ENV"
          echo "PRIVATE_KEY_FILE=$KEY_PATH" >> "$GITHUB_ENV"

      - name: Build, sign, and publish plugin
        env:
          PRIVATE_KEY_PASSWORD: ${{ secrets.JETBRAINS_PRIVATE_KEY_PASSWORD }}
          PUBLISH_TOKEN: ${{ secrets.JETBRAINS_MARKETPLACE_TOKEN }}
        run: ./gradlew clean buildPlugin signPlugin publishPlugin --no-configuration-cache
